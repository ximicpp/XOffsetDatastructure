name: Cross-Platform CI

on:
  push:
    branches: [ main, develop, next_practical ]
  pull_request:
    branches: [ main, develop, next_practical ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # macOS Testing
  # ============================================================================
  test-macos:
    name: macOS (Clang)
    runs-on: macos-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          brew install cmake
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml
          python3 -c "import yaml; print('PyYAML installed for:', __import__('sys').executable)"
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DPython3_EXECUTABLE=$(which python3) \
                ..
      
      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} -j$(sysctl -n hw.ncpu)
      
      - name: Run Tests
        run: |
          cd build
          ctest -C ${{ matrix.build_type }} --output-on-failure -V
      
      - name: Run MSVC Compatibility Test
        run: ./build/bin/test_msvc_compat
      
      - name: Run Demo
        run: ./build/bin/demo
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-macos-${{ matrix.build_type }}
          path: build/Testing/

  # ============================================================================
  # Linux Testing
  # ============================================================================
  test-linux:
    name: Linux (GCC/Clang)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        build_type: [Debug, Release]
        include:
          - compiler: gcc
            cc: gcc-11
            cxx: g++-11
          - compiler: clang
            cc: clang-14
            cxx: clang++-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake python3-pip ${{ matrix.cc }} ${{ matrix.cxx }}
          pip3 install pyyaml
      
      - name: Configure CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} ..
      
      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} -j$(nproc)
      
      - name: Run Tests
        run: |
          cd build
          ctest -C ${{ matrix.build_type }} --output-on-failure -V
      
      - name: Run MSVC Compatibility Test
        run: ./build/bin/test_msvc_compat
      
      - name: Run Demo
        run: ./build/bin/demo
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-linux-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: build/Testing/

  # ============================================================================
  # Windows Testing (MSVC)
  # ============================================================================
  test-windows-msvc:
    name: Windows (MSVC)
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
        arch: [x64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install PyYAML
        run: |
          python --version
          python -m pip --version
          python -m pip install --upgrade pip
          python -m pip install pyyaml
          python -c "import yaml; print('PyYAML version:', yaml.__version__)"
      
      - name: Pre-generate schema headers
        run: |
          echo "Pre-generating schema headers before CMake build..."
          if (-not (Test-Path "generated")) {
            New-Item -ItemType Directory -Path "generated"
          }
          Get-ChildItem -Path "schemas" -Filter "*.xds.yaml" | ForEach-Object {
            python tools/xds_generator.py $_.FullName -o generated/
          }
          echo ""
          echo "Generated headers:"
          Get-ChildItem -Path "generated" -Filter "*.hpp" | ForEach-Object {
            Write-Host "  $_"
            # Touch the file to make it newer than dependencies
            (Get-Item $_).LastWriteTime = Get-Date
          }
          echo ""
          echo "Verification: All headers exist and are up-to-date"
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DSKIP_SCHEMA_GENERATION=ON ..
      
      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} -j $env:NUMBER_OF_PROCESSORS
      
      - name: Run Tests
        run: |
          cd build
          ctest -C ${{ matrix.build_type }} --output-on-failure -V
      
      - name: Run MSVC Compatibility Test
        run: .\build\bin\${{ matrix.build_type }}\test_msvc_compat.exe
      
      - name: Run Demo
        run: .\build\bin\${{ matrix.build_type }}\demo.exe
      
      - name: Test with Type Signature Validation (Experimental)
        continue-on-error: true
        run: |
          mkdir build-sig-validation
          cd build-sig-validation
          cmake -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DENABLE_MSVC_TYPE_SIGNATURE_VALIDATION=ON ..
          cmake --build . --config ${{ matrix.build_type }}
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✅ MSVC type signature validation: ENABLED and WORKING!"
            .\bin\${{ matrix.build_type }}\test_msvc_compat.exe
          } else {
            Write-Host "⚠️ MSVC type signature validation: FAILED (as expected)"
          }
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-windows-msvc-${{ matrix.build_type }}
          path: build/Testing/

  # ============================================================================
  # Android Testing (NDK)
  # ============================================================================
  test-android:
    name: Android (NDK)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86_64]
        api_level: [30]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake python3-pip ninja-build
          pip3 install pyyaml
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Configure CMake for Android
        run: |
          mkdir build-android-${{ matrix.abi }}
          cd build-android-${{ matrix.abi }}
          cmake -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api_level }} \
            -DANDROID_STL=c++_static \
            -DCMAKE_BUILD_TYPE=Release \
            ..
      
      - name: Build for Android
        run: cmake --build build-android-${{ matrix.abi }} --config Release -j$(nproc)
      
      - name: List built binaries
        run: |
          echo "Built binaries for ${{ matrix.abi }}:"
          find build-android-${{ matrix.abi }}/bin -type f -executable
      
      - name: Setup Android Emulator (x86_64 only)
        if: matrix.abi == 'x86_64'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api_level }}
          arch: x86_64
          script: |
            adb push build-android-${{ matrix.abi }}/bin/test_msvc_compat /data/local/tmp/
            adb push build-android-${{ matrix.abi }}/bin/demo /data/local/tmp/
            adb shell "chmod +x /data/local/tmp/test_msvc_compat /data/local/tmp/demo"
            adb shell "cd /data/local/tmp && ./test_msvc_compat"
            adb shell "cd /data/local/tmp && ./demo"
      
      - name: Upload Android binaries
        uses: actions/upload-artifact@v4
        with:
          name: android-binaries-${{ matrix.abi }}
          path: build-android-${{ matrix.abi }}/bin/

  # ============================================================================
  # iOS Testing
  # ============================================================================
  test-ios:
    name: iOS (Xcode)
    runs-on: macos-latest
    strategy:
      matrix:
        platform: [iOS, iOS-simulator]
        include:
          - platform: iOS
            sdk: iphoneos
            arch: arm64
          - platform: iOS-simulator
            sdk: iphonesimulator
            arch: x86_64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          brew install cmake
          pip3 install pyyaml
      
      - name: Pre-generate schema headers
        run: |
          echo "Pre-generating schema headers before Xcode build..."
          mkdir -p generated
          for schema in schemas/*.xds.yaml; do
            python3 tools/xds_generator.py "$schema" -o generated/
          done
          echo "Generated headers:"
          ls -la generated/
      
      - name: Select Xcode version
        run: |
          # List available Xcode versions
          ls /Applications/ | grep Xcode || true
          # Use the default Xcode (usually latest)
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version
      
      - name: Configure CMake for iOS
        run: |
          mkdir build-${{ matrix.platform }}
          cd build-${{ matrix.platform }}
          cmake -G Xcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=14.0 \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_XCODE_ATTRIBUTE_ONLY_ACTIVE_ARCH=NO \
            -DCMAKE_IOS_INSTALL_COMBINED=YES \
            -DSKIP_SCHEMA_GENERATION=ON \
            ..
      
      - name: Build for iOS
        run: |
          cmake --build build-${{ matrix.platform }} --config Release -- -sdk ${{ matrix.sdk }} -arch ${{ matrix.arch }}
      
      - name: List built binaries
        run: |
          echo "Built binaries for ${{ matrix.platform }}:"
          find build-${{ matrix.platform }} -name "*.app" -o -name "test_*" -o -name "demo"
      
      - name: Run tests on iOS Simulator
        if: matrix.platform == 'iOS-simulator'
        continue-on-error: true
        run: |
          echo "=== iOS Simulator Test Execution ==="
          
          # Find simulator
          echo "Step 1: Finding iPhone simulator..."
          SIMULATOR_ID=$(xcrun simctl list devices available 2>&1 | grep "iPhone" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          
          if [ -z "$SIMULATOR_ID" ]; then
            echo "❌ No iPhone simulator found"
            exit 0
          fi
          
          SIMULATOR_NAME=$(xcrun simctl list devices 2>&1 | grep "$SIMULATOR_ID" | sed -E 's/^[[:space:]]+//' | sed -E 's/ \([A-F0-9-]+\).*//')
          echo "✓ Found simulator: $SIMULATOR_NAME ($SIMULATOR_ID)"
          echo ""
          
          # Boot simulator with timeout
          echo "Step 2: Booting simulator..."
          if xcrun simctl boot "$SIMULATOR_ID" 2>&1; then
            echo "✓ Simulator booted successfully"
          else
            echo "⚠ Simulator already booted or boot failed (continuing anyway)"
          fi
          
          echo "Waiting 3 seconds for simulator to be ready..."
          sleep 3
          echo ""
          
          # Find executables using targeted search
          echo "Step 3: Searching for test executables..."
          
          # Xcode builds with specific configuration paths
          POSSIBLE_PATHS=(
            "build-${{ matrix.platform }}/Release-iphonesimulator"
            "build-${{ matrix.platform }}/tests/Release-iphonesimulator"
            "build-${{ matrix.platform }}/examples/Release-iphonesimulator"
            "build-${{ matrix.platform }}/bin/Release"
            "build-${{ matrix.platform }}/bin"
          )
          
          echo "Checking build output locations..."
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -d "$path" ]; then
              echo "  Found directory: $path"
              ls "$path" 2>/dev/null | head -10 || true
            fi
          done
          echo ""
          
          # Search for executables
          echo "Step 4: Looking for test_msvc_compat and demo..."
          TEST_EXEC=""
          DEMO_EXEC=""
          
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -f "$path/test_msvc_compat" ]; then
              TEST_EXEC="$path/test_msvc_compat"
              echo "  ✓ Found test_msvc_compat: $TEST_EXEC"
            fi
            if [ -f "$path/demo" ]; then
              DEMO_EXEC="$path/demo"
              echo "  ✓ Found demo: $DEMO_EXEC"
            fi
          done
          
          if [ -z "$TEST_EXEC" ] && [ -z "$DEMO_EXEC" ]; then
            echo "  ⚠ No executables found in standard locations"
            echo ""
            echo "Performing deep search (this may take a moment)..."
            find "build-${{ matrix.platform }}" -type f \( -name "test_msvc_compat" -o -name "demo" \) 2>/dev/null | while read -r file; do
              echo "  Found: $file"
            done || echo "  No executables found"
          fi
          echo ""
          
          # Run tests
          echo "Step 5: Running tests on simulator..."
          TESTS_RUN=0
          
          if [ -n "$TEST_EXEC" ] && [ -f "$TEST_EXEC" ]; then
            echo "Running test_msvc_compat..."
            if xcrun simctl spawn "$SIMULATOR_ID" "$TEST_EXEC" 2>&1; then
              echo "  ✓ test_msvc_compat completed successfully"
              TESTS_RUN=$((TESTS_RUN + 1))
            else
              echo "  ✗ test_msvc_compat failed"
            fi
            echo ""
          fi
          
          if [ -n "$DEMO_EXEC" ] && [ -f "$DEMO_EXEC" ]; then
            echo "Running demo..."
            if xcrun simctl spawn "$SIMULATOR_ID" "$DEMO_EXEC" 2>&1; then
              echo "  ✓ demo completed successfully"
              TESTS_RUN=$((TESTS_RUN + 1))
            else
              echo "  ✗ demo failed"
            fi
            echo ""
          fi
          
          # Summary
          echo "Step 6: Cleanup..."
          xcrun simctl shutdown "$SIMULATOR_ID" 2>&1 || true
          echo ""
          
          echo "=== Summary ==="
          echo "Simulator: $SIMULATOR_NAME"
          echo "Tests run: $TESTS_RUN"
          if [ $TESTS_RUN -gt 0 ]; then
            echo "✅ iOS Simulator tests completed"
          else
            echo "⚠️  No tests were executed (executables not found or not configured for iOS)"
            echo ""
            echo "Note: iOS builds may require additional configuration to create"
            echo "standalone executables instead of .app bundles."
          fi
      
      - name: Upload iOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: ios-binaries-${{ matrix.platform }}
          path: build-${{ matrix.platform }}/bin/

  # ============================================================================
  # Binary Compatibility Test (Cross-Platform)
  # ============================================================================
  test-binary-compatibility:
    name: Binary Compatibility
    needs: [test-macos, test-linux, test-windows-msvc]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Check binary compatibility
        run: |
          echo "======================================"
          echo "Binary Compatibility Report"
          echo "======================================"
          
          # List all downloaded artifacts
          ls -la
          
          echo ""
          echo "✅ All platforms built successfully!"
          echo ""
          echo "Note: Binary compatibility requires running"
          echo "serialization tests with data exchange between platforms."

  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip3 install pyyaml
      
      - name: Validate YAML schemas
        run: |
          echo "Validating YAML schemas..."
          python3 -c "
          import yaml
          from pathlib import Path
          
          schemas = Path('schemas').glob('*.yaml')
          for schema in schemas:
              print(f'Validating {schema}...')
              with open(schema) as f:
                  yaml.safe_load(f)
              print(f'  ✅ {schema} is valid')
          "
      
      - name: Check generated files are up-to-date
        run: |
          python3 tools/xds_generator.py schemas/game_data.xds.yaml -o generated/
          if git diff --exit-code generated/; then
            echo "✅ Generated files are up-to-date"
          else
            echo "❌ Generated files are out of date. Please run the generator."
            exit 1
          fi

  # ============================================================================
  # Performance Benchmarks
  # ============================================================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake python3-pip
          pip3 install pyyaml
      
      - name: Build with optimizations
        run: |
          mkdir build-bench
          cd build-bench
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-O3 -march=native" ..
          cmake --build . --config Release -j$(nproc)
      
      - name: Run benchmarks
        run: |
          cd build-bench/bin
          echo "Running performance benchmarks..."
          time ./demo
          
          echo ""
          echo "Memory usage test..."
          /usr/bin/time -v ./test_compaction 2>&1 | grep -E "Maximum resident|User time|System time"

  # ============================================================================
  # Summary
  # ============================================================================
  test-summary:
    name: Test Summary
    needs: [test-macos, test-linux, test-windows-msvc, test-android, test-ios]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "======================================"
          echo "XOffsetDatastructure2 CI Summary"
          echo "======================================"
          echo ""
          echo "Platform Test Results:"
          echo "  - macOS:    ${{ needs.test-macos.result }}"
          echo "  - Linux:    ${{ needs.test-linux.result }}"
          echo "  - Windows:  ${{ needs.test-windows-msvc.result }}"
          echo "  - Android:  ${{ needs.test-android.result }}"
          echo "  - iOS:      ${{ needs.test-ios.result }}"
          echo ""
          
          if [ "${{ needs.test-macos.result }}" == "success" ] && \
             [ "${{ needs.test-linux.result }}" == "success" ] && \
             [ "${{ needs.test-windows-msvc.result }}" == "success" ] && \
             [ "${{ needs.test-android.result }}" == "success" ] && \
             [ "${{ needs.test-ios.result }}" == "success" ]; then
            echo "✅ ALL PLATFORMS PASSED!"
            exit 0
          else
            echo "❌ SOME PLATFORMS FAILED"
            exit 1
          fi
